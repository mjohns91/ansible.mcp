---
- hosts: localhost
  gather_facts: true

  vars:
    ansible_mcp_hosts: []
    ansible_mcp_inventory_file_path: "{{ playbook_dir }}/inventory.yml"

  tasks:
    - name: Check if GitHub PAT is available
      ansible.builtin.fail:
        msg: 'The Github PAT must be defined using github_mcp_pat variable'
      when: github_mcp_pat is undefined

    - name: Add GitHub MCP host if PAT is available
      ansible.builtin.set_fact:
        ansible_mcp_hosts: "{{ ansible_mcp_hosts + [github_host] }}"
      vars:
        github_host:
          name: github
          server_name: github
          server_args: []
          bearer_token: "{{ github_mcp_pat }}"
          manifest_path: "{{ playbook_dir }}/manifest.json"

    - name: Check if uvx is installed (for AWS tests)
      ansible.builtin.command: which uvx
      register: uvx_check
      failed_when: false
      changed_when: false

    - name: Add AWS MCP host if uvx is available
      ansible.builtin.set_fact:
        ansible_mcp_hosts: "{{ ansible_mcp_hosts + [aws_host] }}"
      vars:
        aws_host:
          name: aws
          server_name: aws
          server_args: []
          server_env:
            AWS_REGION: "{{ aws_region }}"
            AWS_ACCESS_KEY_ID: "{{ aws_access_key }}"
            AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key }}"
            AWS_SESSION_TOKEN: "{{ security_token }}"
            FASTMCP_LOG_LEVEL: "ERROR"
          manifest_path: "{{ playbook_dir }}/manifest.json"
      when: uvx_check.rc == 0

    - name: Generate inventory file
      ansible.builtin.include_role:
        name: prepare_inventory
