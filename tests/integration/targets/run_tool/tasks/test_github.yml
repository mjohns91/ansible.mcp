---
# GitHub MCP Server Integration Tests for run_tool action plugin
# Testing against ansible-collections organization

- name: Search ansible-collections repositories
  ansible.mcp.run_tool:
    name: search_repositories
    args:
      query: "org:ansible-collections language:python"
  register: github_search_result
- debug: var=github_search_result

- name: Verify search_repositories result
  ansible.builtin.assert:
    that:
      - github_search_result is not failed
      - github_search_result.content is defined
      - github_search_result.content is iterable
      - github_search_result.changed == false
    fail_msg: "search_repositories tool call failed"
    success_msg: "search_repositories tool call succeeded"

- name: Get file contents from amazon.aws collection
  ansible.mcp.run_tool:
    name: get_file_contents
    args:
      owner: ansible-collections
      repo: amazon.aws
      path: README.md
  register: github_file_result
- debug: var=github_file_result

- name: Verify get_file_contents result
  ansible.builtin.assert:
    that:
      - github_file_result is not failed
      - github_file_result.content is defined
      - github_file_result.content | length > 0
      - github_file_result.changed == false
    fail_msg: "get_file_contents tool call failed"
    success_msg: "get_file_contents tool call succeeded"

- name: Get galaxy.yml from community.aws collection
  ansible.mcp.run_tool:
    name: get_file_contents
    args:
      owner: ansible-collections
      repo: community.aws
      path: galaxy.yml
  register: galaxy_file_result
- debug: var=galaxy_file_result

- name: Verify galaxy.yml retrieval
  ansible.builtin.assert:
    that:
      - galaxy_file_result is not failed
      - galaxy_file_result.content is defined
      - galaxy_file_result.content | length > 0
      - galaxy_file_result.changed == false
    fail_msg: "galaxy.yml retrieval failed"
    success_msg: "galaxy.yml retrieval succeeded"

- name: Search for popular ansible collections
  ansible.mcp.run_tool:
    name: search_repositories
    args:
      query: "org:ansible-collections stars:>1000 ansible-collection"
  register: popular_collections_result
- debug: var=popular_collections_result

- name: Verify popular collections search
  ansible.builtin.assert:
    that:
      - popular_collections_result is not failed
      - popular_collections_result.content is defined
      - popular_collections_result.changed == false
    fail_msg: "Popular collections search failed"
    success_msg: "Popular collections search succeeded"
