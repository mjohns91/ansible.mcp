---
- name: AWS CCAPI MCP Server Demo - Create VPC, KeyPair, and EC2
  hosts: aws_ccapi_server
  gather_facts: false
  vars_files:
    - "../../group_vars/all.yml"

  vars:
    resources:
      - name: keypair
        type: "AWS::EC2::KeyPair"
        properties:
          KeyName: "{{ ec2_key_pair }}"

      - name: vpc
        type: "AWS::EC2::VPC"
        properties:
          CidrBlock: "{{ vpc_cidr }}"
          EnableDnsSupport: "{{ vpc_dns_support }}"
          EnableDnsHostnames: "{{ vpc_dns_hostnames }}"
          Tags: "{{ vpc_tags }}"
      
      - name: subnet
        type: "AWS::EC2::Subnet"
        properties: {}  # we will fill dynamically after VPC creation

      - name: ec2
        type: "AWS::EC2::Instance"
        properties_template: {} # we will fill dynamically after subnet creation
        count: "{{ ec2_count }}"
  tasks:
    - name: Get server information
      ansible.mcp.server_info:
      register: server_info

    - name: Display server details
      debug:
        msg: "Connected to {{ server_info.server_info.serverInfo.name }} version {{ server_info.server_info.serverInfo.version }}"

    - name: Check environment variables
      ansible.mcp.run_tool:
        server_name: "{{ ansible_mcp_server_name }}"
        name: check_environment_variables
      register: env_check

    - name: Set environment_token
      set_fact:
        environment_token: "{{ env_check.content[0].text | from_json | json_query('environment_token') }}"

    - name: Find latest Amazon Linux 2 AMI ID
      amazon.aws.ec2_ami_info:
        region: "{{ region }}"
        profile: "{{ profile }}"
        owners:
          - "{{ ami_owner_id }}"
        filters:
          name: "{{ ami_name_pattern }}"
          state: available
      register: ami_info

    - name: Set AMI ID fact
      set_fact:
        ec2_ami_id: >-
          {{
            (ami_info.images
              | default([])
              | sort(attribute='creation_date', reverse=true)
              | map(attribute='image_id')
              | first
            ).strip()
          }}

    - name: Initialize resource_results
      set_fact:
        resource_results: {}

    # Step 1: Create VPC
    - name: Process VPC
      include_tasks: ./tasks/process_resource.yml
      vars:
        resource_item: "{{ resources | selectattr('name', 'equalto', 'vpc') | first }}"

    # Step 2: Create KeyPair
    - name: Process KeyPair
      include_tasks: ./tasks/process_resource.yml
      vars:
        resource_item: "{{ resources | selectattr('name', 'equalto', 'keypair') | first }}"

    # Step 3: Create Subnet
    - name: Process Subnet
      include_tasks: ./tasks/process_resource.yml
      vars:
        resource_item: >-
          {{
            resources | selectattr('name', 'equalto', 'subnet') | first
            | combine({
                'properties': {
                  'VpcId': resource_results['vpc'].content[0].text | from_json | json_query('identifier'),
                  'CidrBlock': "10.1.1.0/24",
                  'AvailabilityZone': region ~ "a",
                  'Tags': [{'Key': 'Name', 'Value': 'demo-subnet'}]
                }
              })
          }}

    # Step 4: Create EC2
    - name: Process EC2
      include_tasks: ./tasks/process_resource.yml
      vars:
        resource_item: >-
          {{
            resources | selectattr('name', 'equalto', 'ec2') | first
            | combine({
                'properties_template': {
                  'InstanceType': ec2_instance_type,
                  'ImageId': ec2_ami_id,
                  'SubnetId': resource_results['subnet'].content[0].text | from_json | json_query('identifier'),
                  'KeyName': resource_results['keypair'].content[0].text | from_json | json_query('identifier'),
                  'Tags': ec2_tags
                }
              })
          }}
      when: >
        resource_results['vpc'] is defined and
        resource_results['keypair'] is defined and
        ec2_ami_id is defined
